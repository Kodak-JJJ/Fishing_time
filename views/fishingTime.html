<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fishing time</title>
</head>

<body>
  <h1>Saltwater fishing</h1>
  <h2>Water Level Predictions</h2>
  <form id="queryForm">
    <label>Station:</label>
    <select id="stationSelector" name="stationId" required>
      <option value="">--Choose--</option>
      <option value="5cebf1e43d0f4a073c4bc45a">Ambleside</option>
      <option value="5cebf1e13d0f4a073c4bbf8c" >Steveston</option>
    </select>
  
    <label>Visit date:</label>
    <input type="date" name="visit_date" required>
  
    <button type="submit">Load data</button>
  </form>
  
  <div>
    <table id="levels" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Time</th>
            <th style="text-align:right; border-bottom:1px solid #ddd; padding:6px;">Water level (m)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
  </div>

  <!-- (B) chart area -->
  <div style="height:420px; margin-top:12px;">
    <canvas id="chart"></canvas>
  </div>

  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
    let chart; // keep reference to destroy when re-plotting

    // Map your API JSON to Chart.js points.
    // You said: time key is "eventDate" (or index [0]) and value key is "value" (or index [2]).
    function toPoints(json) {
      if (!Array.isArray(json)) return [];

      // Case 1: array of objects: { eventDate: "...", value: 1.23, ... }
      if (json.length && !Array.isArray(json[0]) && "eventDate" in json[0] && "value" in json[0]) {
        return json
          .slice()
          .map(r => ({ x: new Date(r.eventDate), y: Number(r.value) }));
      }

      return [];
    }

    function draw(points, title = "Series") {
      const ctx = document.getElementById("chart");

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [{
            label: title,
            data: points,           // [{x: Date, y: Number}, ...]
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.2
          }]
        },
        options: {
          scales: {
            x: { type: "time", time: { tooltipFormat: "PPpp" } },
            y: { beginAtZero: true }
          },
          plugins: {
            decimation: { enabled: true, algorithm: "lttb", samples: 1000 },
            tooltip: { mode: "index", intersect: false }
          }
        }
      });
    }

    function renderTableFromPoints(points, {
        zone = "America/Vancouver",   // use "utc" if you want UTC labels
        decimals = 2,
        target = "#levels tbody",
        } = {}) {
        const tbody = document.querySelector(target);
        if (!tbody) return;

        const rowsHtml = points.map(p => {
            const d = p.x instanceof Date ? p.x : new Date(p.x);
            const timeStr = d.toLocaleString("en-CA", {
            year: "numeric", month: "2-digit", day: "2-digit",
            hour: "2-digit", minute: "2-digit", second: "2-digit",
            timeZone: zone
            });
            const val = Number(p.y);
            return `<tr>
            <td style="padding:6px; border-bottom:1px solid #f0f0f0;">${timeStr}</td>
            <td style="padding:6px; text-align:right; border-bottom:1px solid #f0f0f0;">
                ${Number.isFinite(val) ? val.toFixed(decimals) : ""}
            </td>
            </tr>`;
        }).join("");

        tbody.innerHTML = rowsHtml;
    }

    document.getElementById("queryForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const fd = new FormData(e.target);
      const stationId = fd.get("stationId");
      const visitDate = fd.get("visit_date");

      if (!visitDate) {
        alert("Please choose a date.");
        return;
      }

      // new Date() represents instants in time in local time zone. 
      const fromDate = new Date(visitDate + "T00:00:00");
      const toDate   = new Date(fromDate.getTime() + 24 * 60 * 60 * 1000);

      // toISOString() converts that same instant to a UTC ISO string.
      const fromStr = fromDate.toISOString().slice(0, 19) + "Z";
      const toStr   = toDate.toISOString().slice(0, 19) + "Z";

      const params = new URLSearchParams();
      params.append("time-series-code", "wlp");
      params.append("from", fromStr);
      params.append("to", toStr);
      params.append("resolution", "SIXTY_MINUTES");

      const url = `/stations/${encodeURIComponent(stationId)}/data?${params.toString()}`;

      try {
        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Request failed: ${res.status} ${text}`);
        }
        const json = await res.json();

        const points = toPoints(json);

        renderTableFromPoints(points);

        // Show raw JSON (debug)
        //document.getElementById("out").textContent = JSON.stringify(points, null, 2);
        console.log(points);
        if (!points.length) {
          alert("No plottable points (eventDate/value) found in the response.");
          return;
        }
        const selector = document.getElementById("stationSelector");
        const stationOption = selector.querySelector(`option[value="${stationId}"]`);
        draw(points, `Station ${stationOption.textContent} â€” ${visitDate}`);
      } catch (err) {
        document.getElementById("out").textContent = String(err);
      }
    });
  </script>

  <!-- <h1>River fishing</h1>
  <form id="queryForm">
    <label>Pick a location for fishing:</label>
    <select id="color" name="color">
      <option value="red">Capilano</option>
      <option value="green">Coquitlam</option>
    </select>

    <label for="visit-date">Select a date:</label>
    <input type="date" id="visit-date" name="visit_date" required>
  
    <button type="submit">Send</button>
  </form> -->
</body>

</html>
